---
title: "Analisi degli studi e dell'occupazione in Italia ed Europa"
author: "Filippo Bisconcin, 852144"
date: "24 May 2018"
documentclass: "book"
output:
  pdf_document:
    toc: true
    number_sections: true
classoption: oneside
header-includes:
- \usepackage[italian]{babel}
- \usepackage{placeins}
- \usepackage{setspace}
- \usepackage{chngcntr}
- \usepackage{float}
- \usepackage{fancyhdr}
- \counterwithin{figure}{section}
- \counterwithin{table}{section}
- \pagestyle{plain}
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.path = 'figures/',fig.pos = 'H', echo = FALSE, warning = FALSE, message = FALSE)
```


```{r}
library(ggplot2)
library(devtools)
#install_github("quantide/mapIT")
library(mapIT)
```

\pagenumbering{arabic}
\pagestyle{fancy}
\fancyfoot{}

\renewcommand{\chaptermark}[1]{\markboth{\chaptername\ \thechapter \,-  #1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection \, #1}}
\fancyhead[LE,RO]{\bfseries\thepage}
\fancyhead[RE]{\bfseries\leftmark}
\fancyhead[LO]{\bfseries\rightmark}
\renewcommand{\headrulewidth}{0.3pt}

# Premessa

Durante la stesura del progetto è nata la volontà nel sottoscritto di concentrarsi su un unico argomento, da trattare mediante dataset multipli rispetto all'analisi di tre o più situazioni scollegate tra di loro. 
Tra le diverse proposte sono stati scelti i tre seguenti dataset di cui riportiamo la data di costruzione del campione:

\begin{itemize}
  \item 1) La qualità della vita delle province italiane: 2003/2004
  \item 2) Laureati e lavoro: 2015
  \item 3) Regioni Europee: 2016
\end{itemize}

Essendo di nostro interesse confrontare il grado di dissocupazione in Italia con la disoccupazione post-laurea saremmo costretti a confrontare due dataset costruiti a dodici anni di distanza. Ciò non sarebbe statisticamente accettabile, provvediamo quindi ad includere un quarto dataset messo a disposizione dall'ISTAT dalla quale possiamo estrarre i dati relativi al 2015.

\begin{itemize}
  \item 4) Tasso di disoccupazione: 2015
\end{itemize}

Utilizzeremo il primo dataset (2003) solo per confronti temporali con i dati aggiornati (2015).

```{r, cache=TRUE}
########################## Caricamento dei dati 

ds.pro2003 <- read.table(file="http://venus.unive.it/romanaz/edami/dati/qual_vita04.txt", header=TRUE)
laureati <- read.table("dati/InsProLau_Microdati_Anno_2015.txt", sep="\t",  header=TRUE)
europa <- read.csv2('http://venus.unive.it/romanaz/edami/dati/europe.csv')

# http://www.mandile.it/wp-content/uploads/provincia-regione-sigla.csv
province_regioni <- read.csv(file="dati/provincia-regione-sigla.csv", header=FALSE)
names(province_regioni) <- c("nome_provincia","regione","sigla_provincia")

#http://dati.istat.it/Index.aspx?DataSetCode=DCCV_TAXDISOCCU1

ds.pro2015 <- read.csv("dati/DCCV_TAXDISOCCU1_27052018150244903.csv",sep = ",", header=TRUE)
ds.pro2015 <- ds.pro2015[ds.pro2015$TIME == 2015 & ds.pro2015$Sesso == "totale" & ds.pro2015$ETA1 == "Y_GE15",]

########################## Aggiustamento dei dati

#associo la regione ad ogni provincia
ds.pro2003$regione <- province_regioni[match(ds.pro2003$Sigla,province_regioni$sigla_provincia),2]
ds.pro2015$regione <- province_regioni[match(ds.pro2015$Territorio,province_regioni$nome_provincia),2]

#associo gli ID delle regioni al loro nome

regioni_lauree=c("Piemonte", "Valle d'Aosta", "Lombardia", "Trentino-Alto Adige", "Veneto", "Friuli-Venezia Giulia",  "Liguria",  "Emilia-Romagna", "Toscana",  "Umbria", "Marche", "Lazio",  "Abruzzo",  "Molise", "Campania", "Puglia", "Basilicata", "Calabria", "Sicilia",  "Sardegna")

laureati$regione <- regioni_lauree[laureati$REG_UNI_mIcro]
```

# Italia

Ci interessa analizzare la situazione del nostro Paese in fatto di occupazione e, in particolare, della relazione con le modalità di studio di un campione di laureati.

## Disoccupazione post Laurea

Cominciamo con l'analizzare la disoccupazione dei laureati ad un anno dalla conclusione del loro percorso di studi.

```{r}
laureati$L2_69 = laureati$L2_69 == 1
laureati$disoccupati.entro.anno <- laureati$L2_69 == FALSE
media.disoccupati.dopo.anno <- mean(laureati$disoccupati.entro.anno,na.rm = TRUE)
```

La percentuale nazionale di disoccupati dopo un anno dalla laurea è del `r round(media.disoccupati.dopo.anno*100,0)`%. 

### Analisi per regione

```{r fig.cap = "Percentuale studenti disoccupati dopo  un anno. \\label{figurelabel}"}
#, fig.height=5, fig.width=5
disoccupati.entro.anno <- by(laureati,laureati$REG_UNI_mIcro, function(x) mean(x$disoccupati.entro.anno,na.rm = TRUE))

occupazione.stud.entro.anno <- data.frame(
    Regione = regioni_lauree[as.integer(unlist(rownames(disoccupati.entro.anno)))],
    DisOcc.perc = as.vector(disoccupati.entro.anno)
)

gp <- list(guide.label="Percentuale studenti\ndisoccupati dopo \nun anno", low="#fff0f0", high="red3", show_grid=FALSE)
mapIT(DisOcc.perc, Regione, data=occupazione.stud.entro.anno, graphPar = gp)
```

Una volta analizzata la disoccupazione ad un anno dalla laurea, ci chiediamo se essa sia legata al livello di disoccupazione della regione. 

```{r fig.cap = "Percentuale di disoccupazione regionale nel 2015. \\label{figurelabel}"}
group.pro.2003 <- by(ds.pro2003,ds.pro2003$regione , function(x) mean(x$Dis,na.rm = TRUE))
dis.reg.2003 <- as.data.frame(do.call("rbind", lapply(group.pro.2003,as.list)))
names(dis.reg.2003) <- c("dis.2003")

group.pro.2015 <- by(ds.pro2015,ds.pro2015$regione , function(x) mean(x$Value,na.rm = TRUE))
dis.reg.2015 <- as.data.frame(do.call("rbind", lapply(group.pro.2015,as.list)))
names(dis.reg.2015) <- c("dis.2015")

disoccupazione <- data.frame(
    Regione = row.names(dis.reg.2015),
    DisPerc2015 = as.numeric(dis.reg.2015$dis.2015)/100,
    DisPerc2003 = as.numeric(dis.reg.2003$dis.2003)/100
)

disoccupazione$delta_03_15 <- disoccupazione$DisPerc2015 - disoccupazione$DisPerc2003
disoccupazione$entro_anno <- occupazione.stud.entro.anno[order(occupazione.stud.entro.anno$Regione),2]
disoccupazione_no_na <- na.omit(disoccupazione)




gp <- list(guide.label="Disoccupazione\nPercentuale", low="#fff0f0", high="red3", show_grid=FALSE)
mapIT(DisPerc2015, Regione, data=disoccupazione, graphPar = gp)

#pairs(~ voto_diploma_it + L1_22, data = laureati,col=laureati$L1_22)
```

```{r}
reg<-lm(DisPerc2015 ~ entro_anno, data=disoccupazione_no_na)

plot(disoccupazione_no_na$DisPerc2015*100,disoccupazione_no_na$entro_anno*100 , pch=20,xlab='Disoccupazione (%)',ylab='Laureati disoccupati ad un anno (%)',main='Disoccupazione in Italia',xlim=c(0,40),ylim=c(0,60))#,xlim=c(5,25),ylim=c(25,50))
abline(reg)
centr_x <- mean(disoccupazione_no_na$DisPerc2015*100)
centr_y <- mean(disoccupazione_no_na$entro_anno*100)
points(centr_x, centr_y, pch='*', cex=2,col="red")
abline(v=centr_x, h=centr_y, lwd=2, lty='dotted')
abline(a=0, b=1, lwd=2, col="red")


#

#abline(a=-centr_x, b=1, lwd=2, col="red")
#abline(v=centr_x, h=centr_y, lwd=2, lty='dotted')


#cor(disoccupazione[,2],disoccupazione[,3])
```

Avendo a disposizione due dataset costruiti a dodici anni di distanza, possiamo calcolarci la variazione nella percentuale di disoccupazione. Utilizziamo la solita rappresentazione grafica per mostrare la distribuzione dell'indice appena calcolato.

```{r}
#barplot(disoccupazione$delta_03_15*100,names.arg = disoccupazione$Regione, las=3,col = disoccupazione$delta_03_15 < 0,main = "Aumento dell'occupazione tra il 2003 e il 2015")

miglioramento_medio <- mean(disoccupazione_no_na[disoccupazione_no_na$Regione != "Basilicata",4])

reg<-lm(DisPerc2003~ DisPerc2015, data = disoccupazione_no_na)

plot(disoccupazione_no_na$DisPerc2003*100, disoccupazione_no_na$DisPerc2015*100, pch=20,xlab='Disoccupazione al 2003 (%)',ylab='Disoccupazione al 2015 (%)',main='Disoccupazione in Italia',xlim=c(0,30),ylim=c(0,30))

abline(reg)

centr_x <- mean(disoccupazione_no_na$DisPerc2003*100)
centr_y <- mean(disoccupazione_no_na$DisPerc2015*100)

points(centr_x, centr_y, pch='*', cex=2)
abline(a=0, b=1, lwd=2, col="red")
abline(v=centr_x, h=centr_y, lwd=2, lty='dotted')
#cov(vote$V08, vote$V12)

```

Il grafico soprastante indica la correlazione tra la disoccupazione nelle due annate 2003 e 2015. Punti al di sopra della diagonale indicano regioni la cui disoccupazione nel 2015 risulta minore della rilevazione eseguita nel 2003.

Risulta evidente un aumento del 2.5% della disoccupazione in Basilicata negli ultimi dodici anni. Ad esclusione di quest'ultima, tutte le altre regioni hanno subito una diminuzione media del `r round(miglioramento_medio*100,0)` %

```{r}
gp <- list(guide.label="Variazione 2003-2015", low="red3", high="green3",show_grid=FALSE)
mapIT(delta_03_15, Regione, data=disoccupazione_no_na, graphPar = gp)
```

```{r}
laureati_regioni_grouped <- by(laureati,laureati$regione ,function(x) 
  data.frame(
    
  voto_medio             = mean(x$L1_22,na.rm = TRUE),
  laureati               = length(x[,1]),
  pa                     = mean(x$L2_10 == 1,na.rm = TRUE),
  lascerebbero_italia    = mean(x$L4_14,na.rm = TRUE),
  mag.qual               = mean(x$L4_17D,na.rm = TRUE)
  )
)

ds.laureati_regioni <- data.frame(do.call("rbind", laureati_regioni_grouped))

#ds.laureati_regioni$regione <- row.names(ds.laureati_regioni)
#rownames(ds.laureati_regioni) <- c()
ds.laureati_regioni$delta_03_15 <- disoccupazione_no_na[match(row.names(ds.laureati_regioni) ,disoccupazione_no_na$Regione),]$delta_03_15
ds.laureati_regioni$dis <- disoccupazione_no_na[match(row.names(ds.laureati_regioni) ,disoccupazione_no_na$Regione),]$DisPerc2015
```

## Riduzione dimensionale

Dividiamo il campione di laureati, raggruppato per ambito, in due macro ambiti (*Scientifico* ed *Umanistico*) così suddivisi:

\begin{itemize}
  \item Scientifico: Scientifico, Chimico-farmaceutico, Geo-biologico, Medico, Ingegneria, Architettura, Agrario, Economico-statistico, Educazione fisica, Difesa e sicurezza
  \item Umanistico: Politico-sociale, Giuridico, Letterario, Linguistico, Insegnamento, Psicologico
\end{itemize}

## Riduzione dimensionale delle motivazioni di traferimento

Procediamo ad analizzare le componenti principali delle colonne inerenti al punteggio che hanno dato i laureati alle diverse ragioni per cui migrerebbero in un altro Stato.

```{r}
ambiti_lauree <- c(
  "Scientifico", "Chimico-farmaceutico", "Geo-biologico", "Medico", "Ingegneria", 
  "Architettura", "Agrario", "Economico-statistico", "Politico-sociale", "Giuridico", 
  "Letterario", "Linguistico", "Insegnamento", "Psicologico", "Educazione fisica",
  "Difesa e sicurezza")

ambiti_lauree_sh <- c("SC","CH","GEO","MED","ING",
                      "ARCH","AGR","ECO","POL","GIU",
                      "LET","LIN","INS","PSI","EDF",
                      "SEC")

macro_ambiti <- c("Scientifico", "Umanistico")

macro_ambito <- function(id_ambito){
  rel <- c(1,1,1,1,1,
           1,1,1,2,2,
           2,2,2,2,1,
           1) 
  return(macro_ambiti[rel[id_ambito]])
}

ambiti_grouped <- by(laureati,laureati$GRUPPO_mIcro ,function(x) 
  data.frame(
    id_ambito           = x$GRUPPO_mIcro[1],
    ambito              = ambiti_lauree[x$GRUPPO_mIcro[1]],
    macro_ambito        = macro_ambito(x$GRUPPO_mIcro[1]),
    voto_medio          = mean(x$L1_22,na.rm = TRUE),
    laureati            = length(x[,1]),
    lascerebbero_italia = mean(x$L4_14,na.rm = TRUE),
    occasioni_studio_formazione_scientifica	= mean(x$L4_17A,na.rm = TRUE),
    precedenti_esperienze_studio_lavoro	= mean(x$L4_17B,na.rm = TRUE),
    piu_opportunita_lavoro	= mean(x$L4_17C,na.rm = TRUE),
    lavoro_maggiormente_qualificato	= mean(x$L4_17D,na.rm = TRUE),
    lavoro_maggiormente_retribuito	= mean(x$L4_17E,na.rm = TRUE),
    paese_avanguardia_settore_interesse	= mean(x$L4_17F,na.rm = TRUE),
    accordi_paesi	= mean(x$L4_17G,na.rm = TRUE),
    motivi_familiari_personali= mean(x$L4_17H,na.rm = TRUE)
  )
)
df.laureati_ambiti <- na.omit(data.frame(do.call("rbind", ambiti_grouped)))

#pairs(df.laureati_ambiti[,c(3:5)], col = df.laureati_ambiti$macro_ambito)

#pc <- princomp(df.laureati_ambiti[,-(1:3)], cor = TRUE)
#summary(pc)
#round(cor(df.laureati_ambiti[,-(1:3)], pc$scores[, 1:5]), 2)

pc <- princomp(df.laureati_ambiti[,7:13], cor = TRUE)
summary(pc)
```

Constatiamo che con le prime tre componenti principali riusciamo a riassumere il 90% della varianza del campione e più del 75% con le prime due.

```{r}
round(cor(df.laureati_ambiti[,7:13], pc$scores[, 1:4]), 2)
```

La prima risulta essere fortemente correlata con la variabile "Lavoro maggiormente qualificato" (-0.98) e con "Più opportunità di lavoro" (-0.96).

La seconda è dominata da "Occasioni di studio e formazione scientifica" (0.81).

```{r}
par(mfrow=c(1,2))

plot(pc$scores[, 1:2], col = df.laureati_ambiti$macro_ambito)
abline(h = 0, v = 0, col = "red", lty = "dashed")
text(pc$scores[, 1:2], labels = ambiti_lauree_sh[df.laureati_ambiti$id_ambito], pos = 4, cex = 0.6)

plot(pc$scores[, c(1,3)], col = df.laureati_ambiti$macro_ambito)
abline(h = 0, v = 0, col = "red", lty = "dashed")
text(pc$scores[, c(1,3)], labels = ambiti_lauree_sh[df.laureati_ambiti$id_ambito], pos = 4, cex = 0.6)

#pairs(df.laureati_ambiti[,6:13], col = df.laureati_ambiti$macro_ambito)

```

L'ambito "Difesa e Sicurezza" risulta essere fortemente sbilanciato, motivo che ci spinge a riprovare una seconda analisi nella quale esso verrà escluso.

```{r}
df.laureati_ambiti_nosec <- df.laureati_ambiti[df.laureati_ambiti$id_ambito != 16,]
pc <- princomp(df.laureati_ambiti_nosec[,7:13], cor = TRUE)
#summary(pc)
#round(cor(df.laureati_ambiti_nosec[,7:13], pc$scores[, 1:4]), 2)

par(mfrow=c(1,2))

plot(pc$scores[, 1:2], col = df.laureati_ambiti_nosec$macro_ambito)
abline(h = 0, v = 0, col = "red", lty = "dashed")
text(pc$scores[, 1:2], labels = ambiti_lauree_sh[df.laureati_ambiti_nosec$id_ambito], pos = 4, cex = 0.6)

plot(pc$scores[, c(1,3)], col = df.laureati_ambiti_nosec$macro_ambito)
abline(h = 0, v = 0, col = "red", lty = "dashed")
text(pc$scores[, c(1,3)], labels = ambiti_lauree_sh[df.laureati_ambiti_nosec$id_ambito], pos = 4, cex = 0.6)
```

## Riduzione dimensionale 2

```{r}
k <- na.omit(ds.laureati_regioni)
#pairs(laureati[,c(11,32,84)]) # k

#k <- k(ps[, 4:8], center = pc2$center, scale = pc2$scale)

pc <- princomp(k,cor = TRUE)
summary(pc)
round(cor(k, pc$scores[, 1:4]), 2)

par(mfrow=c(1,2))

plot(pc$scores[, 1:2],col = df.laureati_ambiti$macro_ambito)
abline(h = 0, v = 0, col = "red", lty = "dashed")
text(pc$scores[, 1:2], labels = ambiti_lauree_sh[df.laureati_ambiti$id_ambito], pos = 4, cex = 0.6)

plot(pc$scores[, c(1,3)],col = df.laureati_ambiti$macro_ambito)
abline(h = 0, v = 0, col = "red", lty = "dashed")
text(pc$scores[, c(1,3)], labels = ambiti_lauree_sh[df.laureati_ambiti$id_ambito], pos = 4, cex = 0.6)

k <- na.omit(laureati[,c(11,19,20,21,22,23,24,32,84,99,100,101,102,103,104,105,106,107,135,172,173,174,175,176,177,178)])


```

## 3

Avendo scoperto che la ricerca di lavoro maggiormente qualificato riassumeva molto bene tutte le ragioni per la quale un lareato sarebbe andato all'estero, utilizziamo quest'ultima per confrontarla con  

...

della regione


```{r}

df3 <- ds.laureati_regioni[,c(6,5)]

plot(df3)

d <- dist(scale(df3), method="euclidean")
dendro_ave <- hclust(d, method="average")
plot(dendro_ave, xlab="Unita’", ylab="Distanza Euclidea",
main="Genitori e Figli", labels=FALSE, hang=-1, sub="Legame Medio")

n_ps <- 20

text(1:n_ps, rep(-0.1,n_ps), labels=rownames(ds.laureati_regioni)[dendro_ave$order], cex=0.7, las=3)

dendro_ave$merge # crescita dell’albero dalle foglie verso la radice
```


# Europa

Ci chiediamo se l'appartenenza o meno all'unione europea abbia una qualche relazione con la percentuale di studenti che interrompono gli studi prematuramente. 

```{r}
zona_euro <- europa[europa$eu == "y",]
no_zona_euro <- europa[europa$eu != "y",]

boxplot(zona_euro$ledu,no_zona_euro$ledu,names=c("EU","NO EU"))
abline(h = mean(europa[europa$country == "Italy",]$ledu), col = "red") 
```

Allo scopo di farci un'idea della posizione del nostro Paese, rappresentiamo la media dei nostri abbandoni con una linea rossa. Ci accorgiamo di essere vicini al terzo quartile della distribuzione EU e al primo quartile della distribuzione NO-EU.

Notiamo una notevole differenza tra i due gruppi di stati: i paesi appartenenti all'Unione Europea risultano avere una minore percentuale di abbandoni prematuri degli studi.

```{r}
# PCA (standardized data) 
x <- na.omit(europa[,c(6,7,8,9,10,13,14,15,18,21,24)])
pc <- princomp(x, cor=TRUE)
summary(pc)
round(cor(x,pc$scores[,1:6]),2)

col <- europa$eu

plot(pc$scores[,1:2], xlab="PC1 (__%)", ylab="PC2 (__%)", cex=0.7, col=col)
pairs(pc$scores[,1:5],col=col)
```

# Conclusioni

## Considerazioni personali

Non è stato semplice gestire la mole di dati analizzata, in particolare il dataset relativo ai laureati. La quantità di variabili, codificate tramite valori non intuitivi non ha semplificato l'analisi.
